---
title: "catlvm : CATegorical Latent Variable Model"
subtitle: "Upward-Downward Algorithm"
author: 
 - name: "Youngsun Kim"
   email: "kim0sun@korea.ac.kr"
   address: "Department of Statistics \\newline Korea University"
fontsize: 11pt
fontfamily: mathpazo
kotex: true
# abstract: \lipsum[1]
# keywords: 
#  - "keyword 1"
#  - "keyword 2"
#  - "keyword 3"
#  - "..."
output: 
   ysktmplt::pdf_manuscript:
      keep_tex: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Hidden Markov tree {#hmt}


# Hierarchical latent class model {#hlca}
$$
\pi_k = \textsf{Pr}\left( C_1 = k \right),
\;\;
\tau_{k|l}^{(u)} = \textsf{Pr}\left( C_u = k|C_{\rho(u)} = l \right),
\; \text{and} \;\;
\rho_{mr|k}^{(u)} = \textsf{Pr}\left( Y_{m(u)} = r | C_{u} = k \right)
$$
Upward recursion
$$
\begin{aligned}
\xi_{i(u)}(k) &= \textsf{Pr}\left( \mathbf{Y}_{i(u)} = \mathbf{y}_{i(u)} | C_u = k \right) = 
\prod_{m = 1}^{M} \rho_{my_m|k}^{(u)}
\\
\lambda_{i(u)}(k) &= \xi_{i(u)}(k), \quad \text{where} \quad \mathbf{c}(u) = \emptyset
\\
\lambda_{i(u, \rho(u))}(l) &= \sum_k \tau_{k, l}^{(u)} \lambda_{i(u)}(k)
\\
\lambda_{i(v)}(k) &= \left\{ \prod_{u\in \mathbf{c}(v)} \lambda_{i(u, v)}(k) \right\} \xi_{i(v)}(k)
\end{aligned}
$$

Downward recursion
$$
\begin{aligned}
\alpha_{i(u)}(k) = \sum_{l}\frac{\tau_{k|l}^{(u)} \alpha_{i(\rho(u))}(l)  \lambda_{i(\rho(u))}(l)}{\lambda_{i(u, \rho(u))}(l)}
\end{aligned}
$$

Posterior probabilities
$$
\begin{aligned}
\theta_{i(u)}(k) &= \textsf{Pr}\left( C_u = k | \bar{\mathbf{Y}}_i = \bar{\mathbf{y}}_i \right) 
= \frac{ \textsf{Pr}\left( C_u = k, \bar{\mathbf{Y}}_i = \bar{\mathbf{y}}_i \right) }{ \textsf{Pr}\left( \bar{\mathbf{Y}}_i = \bar{\mathbf{y}}_i \right) }
\\
&=\frac{ \textsf{Pr}\left( C_u = k, \bar{\mathbf{Y}}_{i(1\backslash u)} = \bar{\mathbf{y}}_{i(1\backslash u)} \right) \times \textsf{Pr}\left( \bar{\mathbf{Y}}_{i(u)} = \bar{\mathbf{y}}_{i(u)} | C_u = k \right) }{ \textsf{Pr}\left( \bar{\mathbf{Y}}_i = \bar{\mathbf{y}}_i \right) }
\\
&= \frac{ \alpha_{i(u)}(k) \lambda_{i(u)}(k) }{ \sum_j \alpha_{i(v)}(j) \lambda_{i(v)}(j) }
\end{aligned}
$$
$$
\begin{aligned}
\theta_{i(\rho(u), u)}(k,l) &= \textsf{Pr}\left( C_u = k, C_{\rho(u)} = l | \bar{\mathbf{Y}}_i = \bar{\mathbf{y}}_i \right) 
= \frac{\lambda_{i(u)}(k) \tau_{k|l}^{(u)} \alpha_{i(\rho(u))}(j)  \lambda_{i(\rho(u))}(j)}{\lambda_{i(u, \rho(u))}(j) \sum_j \alpha_{i(v)}(j) \lambda_{i(v)}(j)}
\end{aligned}
$$


# Hessian

$$
\frac{\partial \log L}{\partial \beta_{qj} \partial \beta_{pk}} = \sum_i x_{ip} x_{iq} \left\{ \zeta_{kj} (\theta_{ik} - \pi_{k}) - (\theta_{ik} \theta_{ij} - \pi_k \pi_j) \right\}
$$

$$
\frac{\partial \log L}{\partial \beta_{qj} \partial \beta_{pk|l}} = \sum_i x_{ip} x_{iq} \left( \theta_{i(k,l)} - \tau_{k|l}\theta_{i(l)} \right) \left( \zeta_{kl} - \theta_{i(j)} \right)
$$

$$
\frac{\partial \log L}{\partial \beta_{qj|m} \partial \beta_{pk|l}} = 
\sum_i x_{ip} x_{iq} \left\{ \zeta_{ml} \left[ 
\left( \theta_{i(k,l)} - \tau_{k|l}\theta_{i(l)} \right)\left( \zeta_{jk} - \tau_{j|l} \right) - 
\tau_{k|l} \left( \theta_{i(j,l)} - \tau_{j|l}\theta_{i(l)} \right) \right] - 
\left( \theta_{i(j,m)} - \tau_{j|m}\theta_{i(m)} \right) \left( \theta_{i(k,l)} - \tau_{k|l}\theta_{i(l)} \right)\right\}
$$









